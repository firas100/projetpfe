<!-- candidate-history.component.html -->
<div class="candidate-history-container">
  <div class="header-section">
    <h2 class="page-title">Historique des Candidats</h2>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="loadAllHistories()" [disabled]="loading">
        <i class="fas fa-refresh"></i> Actualiser
      </button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="loading-text">Chargement des historiques...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="error && !loading" class="error alert alert-danger d-flex align-items-center">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
    <button type="button" class="btn-close ms-auto" (click)="error = ''"></button>
  </div>

  <!-- All Histories View (default) -->
  <div *ngIf="!selectedHistory && !loading" class="all-histories">
    <div class="row">
      <div *ngFor="let history of histories; trackBy: trackByCandidateId" class="col-md-6 col-lg-4 mb-4">
        <div class="candidate-card">
          <div class="candidate-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0">{{ history.prenom }} {{ history.nom }} <span class="badge bg-secondary ms-2">ID: {{ history.candidateId }}</span></h3>
            <button class="btn btn-sm btn-outline-primary" (click)="loadHistoryById(history.candidateId)">
              <i class="fas fa-eye"></i> Détails
            </button>
          </div>
          <div class="applications-section mt-3">
            <h5 class="section-title"><i class="fas fa-file-alt me-2"></i>Candidatures ({{ history.applications?.length || 0 }})</h5>
            <div class="table-responsive" *ngIf="history.applications && history.applications.length > 0">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Statut</th>
                    <th>Offre</th>
                    <th>Score CV</th>
                    <th>Score Vidéo</th>
                    <th>Entretien</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let app of history.applications; trackBy: trackByApplicationId">
                    <td>{{ app.candidatureId }}</td>
                    <td>{{ formatDate(app.dateCandidature) }}</td>
                    <td><span class="badge" [ngClass]="{'bg-success': app.statutCandidature === 'ACCEPTÉE', 'bg-warning': app.statutCandidature === 'EN_ATTENTE', 'bg-danger': app.statutCandidature === 'REFUSÉE'}">{{ app.statutCandidature }}</span></td>
                    <td>{{ app.titreOffre }} (ID: {{ app.idOffre }})</td>
                    <td>{{ app.cvScore || 'N/A' }}</td>
                    <td>{{ app.videoScore || 'N/A' }}</td>
                    <td>
                      <span *ngIf="app.interviewStatus !== 'NON_PLANIFIE'" class="badge bg-info">{{ app.interviewStatus }}</span>
                      <span *ngIf="app.interviewStatus === 'NON_PLANIFIE'" class="text-muted">Non planifié</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p *ngIf="!(history.applications && history.applications.length > 0)" class="no-data text-center">
              <i class="fas fa-inbox me-2"></i>Aucune candidature trouvée.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Section (optional, for dev) -->
    <div class="test-section mt-4 p-3 bg-light rounded" *ngIf="false"> <!-- Set to true for testing -->
      <h6>Debug: Charger historique par ID</h6>
      <div class="input-group">
        <input type="number" class="form-control" [(ngModel)]="candidateIdInput" placeholder="Entrez ID">
        <button class="btn btn-outline-secondary" (click)="loadHistoryByIdInput()" [disabled]="!candidateIdInput">
          Charger
        </button>
      </div>
    </div>
  </div>

  <!-- Single History View -->
  <div *ngIf="selectedHistory && !loading" class="single-history">
    <div class="back-link mb-3">
      <button class="btn btn-outline-secondary" (click)="loadAllHistories()">
        <i class="fas fa-arrow-left me-2"></i>Retour à tous les historiques
      </button>
      <button class="btn btn-success ms-2" (click)="openCv()">
        <i class="fas fa-download me-2"></i>Télécharger CV
      </button>
    </div>
    <div class="candidate-header mb-4">
      <h3 class="mb-1">{{ selectedHistory.prenom }} {{ selectedHistory.nom }} <span class="badge bg-secondary">ID: {{ selectedHistory.candidateId }}</span></h3>
      <p class="text-muted mb-0">CV: {{ selectedHistory.cvPath || 'Non disponible' }}</p>
    </div>
    <div class="applications-section">
      <h4 class="section-title"><i class="fas fa-file-alt me-2"></i>Candidatures ({{ selectedHistory.applications?.length || 0 }})</h4>
      <div class="table-responsive" *ngIf="selectedHistory.applications && selectedHistory.applications.length > 0">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>ID Candidature</th>
              <th>Date</th>
              <th>Statut</th>
              <th>Offre</th>
              <th>Score CV</th>
              <th>Années Exp.</th>
              <th>Score Vidéo</th>
              <th>Statut Entretien</th>
              <th>Commentaire</th>
              <th>CV</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let app of selectedHistory.applications; trackBy: trackByApplicationId">
              <td>{{ app.candidatureId }}</td>
              <td>{{ formatDate(app.dateCandidature) }}</td>
              <td><span class="badge" [ngClass]="{'bg-success': app.statutCandidature === 'ACCEPTÉE', 'bg-warning': app.statutCandidature === 'EN_ATTENTE', 'bg-danger': app.statutCandidature === 'REFUSÉE'}">{{ app.statutCandidature }}</span></td>
              <td>{{ app.titreOffre }} (ID: {{ app.idOffre }})</td>
              <td>{{ app.cvScore || 'N/A' }}</td>
              <td>{{ safeValue(app.yearsOfExperience) }}</td>
              <td>{{ app.videoScore || 'N/A' }}</td>
              <td>
                <span *ngIf="app.interviewStatus !== 'NON_PLANIFIE'" class="badge bg-info">{{ app.interviewStatus }}</span>
                <span *ngIf="app.interviewStatus === 'NON_PLANIFIE'" class="text-muted">Non planifié</span>
              </td>
              <td>{{ app.commentaire || 'N/A' }}</td>
              <td>
                <a *ngIf="app.cvPath" [href]="'http://localhost:8086/files/cv/' + app.cvPath" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye"></i> Voir
                </a>
                <span *ngIf="!app.cvPath" class="text-muted">Non disponible</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p *ngIf="!(selectedHistory.applications && selectedHistory.applications.length > 0)" class="no-data text-center">
        <i class="fas fa-inbox me-2"></i>Aucune candidature trouvée.
      </p>
    </div>
  </div>
</div>