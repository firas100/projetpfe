<!-- ═══════════════════════════════════════════════════════════════
     ULTIMATE PREMIUM HR RECRUITMENT DASHBOARD - JOB OFFERS MODULE
     Enhanced Design System - Professional Recruitment Experience
     ═══════════════════════════════════════════════════════════════ -->

<!-- NAVBAR - Ultimate Premium Design -->
<nav class="navbar">
  <div class="navbar-container">
    <!-- Left Section -->
    <div class="navbar-left">
      <button class="hamburger" (click)="toggleSidebar()" aria-label="Toggle sidebar">
        <span></span>
        <span></span>
        <span></span>
      </button>
      
      <div class="brand-logo">
        <div class="logo-icon">
          <i class="fas fa-rocket"></i>
          <div class="logo-shine"></div>
        </div>
        <div class="logo-text">
          <span class="brand">SIGA</span>
          <span class="brand-sub">Recruitment Excellence</span>
        </div>
      </div>
    </div>

    <!-- Center Search -->
    <form class="search-wrapper" (submit)="$event.preventDefault(); applyFilter()">
      <div class="search-field">
        <i class="fas fa-search search-icon"></i>
        <input
          class="search"
          type="search"
          [(ngModel)]="searchTerm"
          name="search"
          placeholder="Rechercher une offre par titre, compétences..."
          aria-label="Search offers"
          (input)="applyFilter()"
        />
        <button 
          *ngIf="searchTerm" 
          type="button" 
          class="search-clear"
          (click)="clearSearch()"
          aria-label="Clear search"
        >
          <i class="fas fa-times"></i>
        </button>
        <kbd class="search-shortcut">⌘K</kbd>
      </div>
    </form>

    <!-- Right Section -->
    <div class="navbar-right">
      <button class="icon-btn notif-btn" title="Notifications" aria-label="Notifications">
        <i class="fas fa-bell"></i>
        <span class="badge-dot"></span>
        <span class="badge-count">3</span>
      </button>
      
      <div class="divider-vertical"></div>
      
      <div class="user-menu">
        <div class="user-avatar">
          <div class="avatar-gradient">
            <span>{{ username.charAt(0).toUpperCase() }}</span>
          </div>
          <div class="status-indicator online"></div>
        </div>
        <div class="user-details">
          <span class="user-greeting">Bonjour,</span>
          <span class="user-name">{{ username }}</span>
        </div>
        <button class="btn-logout" title="Déconnexion" (click)="onLogout()" aria-label="Logout">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </div>
  <div class="navbar-glow"></div>
</nav>

<!-- SIDEBAR - Ultimate Premium Design -->
<aside class="sidebar" [class.collapsed]="sidebarCollapsed">
  <div class="sidebar-header">
    <div class="sidebar-brand">
      <div class="brand-icon">
        <i class="fas fa-users-cog"></i>
        <div class="icon-pulse"></div>
      </div>
      <span class="brand-text">SIGA HR</span>
    </div>
    <button class="collapse-toggle" (click)="toggleSidebar()" aria-label="Toggle sidebar">
      <i class="fas" [ngClass]="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
    </button>
  </div>

  <nav class="sidebar-nav">
    <!-- Main Menu -->
    <div class="nav-section">
      <span class="nav-section-title">Menu Principal</span>
      
   
   

    <a routerLink="/HistoriqueManger" class="nav-link" routerLinkActive="active">
      <div class="nav-icon"><i class="fas fa-history"></i></div>
      <span class="nav-text">Historique</span>
      <div class="nav-indicator"></div>
    </a>

    <a routerLink="/CalendrierManger" routerLinkActive="active"><i class="fas fa-calendar-alt"></i><span class="link-text">Calendrier</span></a>



    

  </div>

    
  </nav>

  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar-small">
        <span>{{ username.charAt(0).toUpperCase() }}</span>
        <div class="avatar-ring"></div>
      </div>
      <div class="user-info-small">
        <span class="user-name-small">{{ username }}</span>
        <span class="user-role">Administrateur RH</span>
      </div>
    </div>
    
    <div class="app-version">
      <i class="fas fa-shield-check"></i>
      <span>Version 1.0.0</span>
    </div>
  </div>
</aside>


<!-- MAIN CONTENT -->
<main class="main-content" [class.expanded]="sidebarCollapsed">
  
  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="page-header-content">
      <div class="page-title-section">
        <h1 class="page-title">
          <i class="fas fa-history"></i>
          Historique des Candidats
        </h1>
        <p class="page-subtitle">Consultez l'historique complet des candidatures et entretiens</p>
      </div>
      <button class="btn-refresh" (click)="loadAllHistories()" [disabled]="loading">
        <i class="fas fa-sync-alt" [class.spinning]="loading"></i>
        <span>Actualiser</span>
        <div class="btn-shine"></div>
      </button>
    </div>
  </div>

  <!-- STATS SECTION -->
  <section class="stats-grid" *ngIf="!selectedHistory">
    <div class="stat-card stat-primary">
      <div class="stat-card-inner">
        <div class="stat-icon-wrapper">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-icon-bg"></div>
        </div>
        <div class="stat-details">
          <div class="stat-label">Total Candidats</div>
          <div class="stat-value">{{ filteredHistories.length }}</div>
          <div class="stat-meta">
            <i class="fas fa-database"></i>
            <span>Dans la base</span>
          </div>
        </div>
      </div>
      <div class="stat-card-glow"></div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-card-inner">
        <div class="stat-icon-wrapper">
          <div class="stat-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="stat-icon-bg"></div>
        </div>
        <div class="stat-details">
          <div class="stat-label">Total Candidatures</div>
          <div class="stat-value">{{ getTotalApplications() }}</div>
          <div class="stat-meta">
            <i class="fas fa-clipboard-list"></i>
            <span>Applications</span>
          </div>
        </div>
      </div>
      <div class="stat-card-glow"></div>
    </div>

    <div class="stat-card stat-info">
      <div class="stat-card-inner">
        <div class="stat-icon-wrapper">
          <div class="stat-icon">
            <i class="fas fa-check-double"></i>
          </div>
          <div class="stat-icon-bg"></div>
        </div>
        <div class="stat-details">
          <div class="stat-label">Candidatures Acceptées</div>
          <div class="stat-value">{{ getAcceptedApplications() }}</div>
          <div class="stat-progress">
            <div class="progress-bar">
              <div 
                class="progress-fill" 
                [style.width.%]="getAcceptanceRate()"
              ></div>
            </div>
            <span class="progress-text">{{ getAcceptanceRate() | number:'1.0-0' }}%</span>
          </div>
        </div>
      </div>
      <div class="stat-card-glow"></div>
    </div>
  </section>

  <!-- LOADING STATE -->
  <div *ngIf="loading" class="state-container loading-state">
    <div class="state-content">
      <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <i class="fas fa-history spinner-icon"></i>
      </div>
      <h3>Chargement des historiques...</h3>
      <p>Veuillez patienter un instant</p>
    </div>
  </div>

  <!-- ERROR STATE -->
  <div *ngIf="error && !loading" class="state-container error-state">
    <div class="state-content">
      <div class="state-icon error-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3>Une erreur est survenue</h3>
      <p>{{ error }}</p>
      <button class="btn-state-action" (click)="loadAllHistories()">
        <i class="fas fa-redo"></i>
        Réessayer
      </button>
    </div>
  </div>

  <!-- EMPTY STATE -->
  <div *ngIf="!loading && !error && filteredHistories.length === 0 && !selectedHistory" class="state-container empty-state">
    <div class="state-content">
      <div class="state-icon empty-icon">
        <i class="fas fa-inbox"></i>
      </div>
      <h3>{{ searchTerm ? 'Aucun résultat trouvé' : 'Aucun historique disponible' }}</h3>
      <p *ngIf="searchTerm">
        Aucun candidat ne correspond à <strong>"{{ searchTerm }}"</strong>
      </p>
      <p *ngIf="!searchTerm">
        Aucun historique de candidature n'est disponible pour le moment
      </p>
      <button *ngIf="searchTerm" class="btn-state-action" (click)="clearSearch()">
        <i class="fas fa-times"></i>
        Effacer la recherche
      </button>
    </div>
  </div>

  <!-- ALL HISTORIES GRID VIEW -->
  <div *ngIf="!selectedHistory && !loading && !error && filteredHistories.length > 0" class="histories-grid">
    <article *ngFor="let history of filteredHistories; trackBy: trackByCandidateId" class="history-card">
      
      <!-- Card Header -->
      <div class="history-card-header">
        <div class="candidate-info">
          <div class="candidate-avatar">
            <span>{{ history.prenom.charAt(0) }}{{ history.nom.charAt(0) }}</span>
          </div>
          <div class="candidate-details">
            <h3 class="candidate-name">{{ history.prenom }} {{ history.nom }}</h3>
            <span class="candidate-id">ID: {{ history.candidateId }}</span>
          </div>
        </div>
        <button class="btn-view-details" (click)="loadHistoryById(history.candidateId)">
          <i class="fas fa-eye"></i>
          <span>Détails</span>
        </button>
      </div>

      <!-- Card Body -->
      <div class="history-card-body">
        <div class="applications-summary">
          <div class="summary-header">
            <i class="fas fa-file-alt"></i>
            <span>Candidatures</span>
            <div class="summary-count">{{ history.applications?.length || 0 }}</div>
          </div>

          <div *ngIf="history.applications && history.applications.length > 0" class="applications-preview">
            <div *ngFor="let app of getPreviewApplications(history.applications); let i = index" 
                 class="application-preview-item">
              <div class="preview-left">
                <span class="preview-number">{{ i + 1 }}</span>
                <div class="preview-info">
                  <span class="preview-title">{{ app.titreOffre }}</span>
                  <span class="preview-date">{{ formatDate(app.dateCandidature) }}</span>
                </div>
              </div>
              <div class="preview-right">
                <span class="preview-status" 
                      [class.status-accepted]="app.statutCandidature === 'ACCEPTÉE'"
                      [class.status-pending]="app.statutCandidature === 'EN_ATTENTE'"
                      [class.status-rejected]="app.statutCandidature === 'REFUSÉE'">
                  {{ app.statutCandidature }}
                </span>
              </div>
            </div>
            
            <div *ngIf="history.applications.length > 3" class="preview-more">
              <i class="fas fa-ellipsis-h"></i>
              <span>+{{ history.applications.length - 3 }} autres candidatures</span>
            </div>
          </div>

          <div *ngIf="!(history.applications && history.applications.length > 0)" class="no-applications">
            <i class="fas fa-inbox"></i>
            <span>Aucune candidature</span>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="quick-stat">
            <i class="fas fa-chart-line"></i>
            <span class="stat-value">{{ getAverageCvScore(history.applications) }}</span>
            <span class="stat-label">Score CV Moyen</span>
          </div>
          <div class="quick-stat">
            <i class="fas fa-video"></i>
            <span class="stat-value">{{ getVideoCount(history.applications) }}</span>
            <span class="stat-label">Vidéos</span>
          </div>
          <div class="quick-stat">
            <i class="fas fa-calendar-check"></i>
            <span class="stat-value">{{ getInterviewCount(history.applications) }}</span>
            <span class="stat-label">Entretiens</span>
          </div>
        </div>
      </div>

      <div class="card-hover-effect"></div>
    </article>
  </div>

  <!-- SINGLE HISTORY DETAIL VIEW -->
  <div *ngIf="selectedHistory && !loading" class="detail-view">
    
    <!-- Back Navigation -->
    <div class="detail-header">
      <button class="btn-back" (click)="loadAllHistories()">
        <i class="fas fa-arrow-left"></i>
        <span>Retour aux candidats</span>
      </button>
      
      <div class="detail-actions">
        <button class="btn-download-cv" (click)="openCv()" *ngIf="selectedHistory.cvPath">
          <i class="fas fa-file-pdf"></i>
          <span>Télécharger CV</span>
        </button>
      </div>
    </div>

    <!-- Candidate Profile Card -->
    <div class="profile-card">
      <div class="profile-main">
        <div class="profile-avatar-large">
          <span>{{ selectedHistory.prenom.charAt(0) }}{{ selectedHistory.nom.charAt(0) }}</span>
          <div class="avatar-ring-large"></div>
        </div>
        <div class="profile-info">
          <h2 class="profile-name">{{ selectedHistory.prenom }} {{ selectedHistory.nom }}</h2>
          <div class="profile-meta">
            <span class="meta-badge">
              <i class="fas fa-id-card"></i>
              ID: {{ selectedHistory.candidateId }}
            </span>
            <span class="meta-badge" *ngIf="selectedHistory.cvPath">
              <i class="fas fa-file-pdf"></i>
              CV Disponible
            </span>
          </div>
        </div>
      </div>

      <div class="profile-stats">
        <div class="profile-stat-item">
          <div class="stat-icon-sm">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="stat-content-sm">
            <span class="stat-value-sm">{{ selectedHistory.applications?.length || 0 }}</span>
            <span class="stat-label-sm">Candidatures</span>
          </div>
        </div>
        <div class="profile-stat-item">
          <div class="stat-icon-sm">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-content-sm">
            <span class="stat-value-sm">{{ getAcceptedCount(selectedHistory.applications) }}</span>
            <span class="stat-label-sm">Acceptées</span>
          </div>
        </div>
        <div class="profile-stat-item">
          <div class="stat-icon-sm">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content-sm">
            <span class="stat-value-sm">{{ getPendingCount(selectedHistory.applications) }}</span>
            <span class="stat-label-sm">En attente</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Applications Section -->
    <div class="applications-detail-section">
      <div class="section-header-detail">
        <div class="section-title-detail">
          <i class="fas fa-clipboard-list"></i>
          <h3>Historique des Candidatures</h3>
        </div>
        <span class="section-count">{{ selectedHistory.applications?.length || 0 }} candidature(s)</span>
      </div>

      <div *ngIf="selectedHistory.applications && selectedHistory.applications.length > 0" class="applications-list">
        
        <div *ngFor="let app of selectedHistory.applications; trackBy: trackByApplicationId" class="application-detail-card">
          
          <!-- Application Header -->
          <div class="app-detail-header">
            <div class="app-header-left">
              <div class="app-icon">
                <i class="fas fa-briefcase"></i>
              </div>
              <div class="app-title-section">
                <h4 class="app-title">{{ app.titreOffre }}</h4>
                <div class="app-meta-row">
                  <span class="app-meta-item">
                    <i class="fas fa-hashtag"></i>
                    ID: {{ app.candidatureId }}
                  </span>
                  <span class="app-meta-item">
                    <i class="fas fa-calendar"></i>
                    {{ formatDate(app.dateCandidature) }}
                  </span>
                  <span class="app-meta-item">
                    <i class="fas fa-briefcase"></i>
                    Offre #{{ app.idOffre }}
                  </span>
                </div>
              </div>
            </div>
            <div class="app-header-right">
              <span class="app-status-badge"
                    [class.status-accepted]="app.statutCandidature === 'ACCEPTÉE'"
                    [class.status-pending]="app.statutCandidature === 'EN_ATTENTE'"
                    [class.status-rejected]="app.statutCandidature === 'REFUSÉE'">
                <i class="fas" 
                   [ngClass]="{
                     'fa-check-circle': app.statutCandidature === 'ACCEPTÉE',
                     'fa-clock': app.statutCandidature === 'EN_ATTENTE',
                     'fa-times-circle': app.statutCandidature === 'REFUSÉE'
                   }"></i>
                {{ app.statutCandidature }}
              </span>
            </div>
          </div>

          <!-- Application Details Grid -->
          <div class="app-detail-grid">
            
            <!-- Scores Section -->
            <div class="detail-section">
              <div class="detail-section-title">
                <i class="fas fa-chart-bar"></i>
                <span>Scores & Évaluation</span>
              </div>
              <div class="detail-items">
                <div class="detail-item">
                  <span class="detail-label">Score CV</span>
                  <span class="detail-value score-value">
                    {{ app.cvScore || 'N/A' }}
                    <span *ngIf="app.cvScore" class="score-indicator" [class.score-high]="app.cvScore >= 70" [class.score-medium]="app.cvScore >= 40 && app.cvScore < 70" [class.score-low]="app.cvScore < 40">
                      <i class="fas fa-circle"></i>
                    </span>
                  </span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Score Vidéo</span>
                  <span class="detail-value score-value">
                    {{ app.videoScore || 'N/A' }}
                    <span *ngIf="app.videoScore" class="score-indicator" [class.score-high]="app.videoScore >= 70" [class.score-medium]="app.videoScore >= 40 && app.videoScore < 70" [class.score-low]="app.videoScore < 40">
                      <i class="fas fa-circle"></i>
                    </span>
                  </span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Années d'Expérience</span>
                  <span class="detail-value">{{ safeValue(app.yearsOfExperience) }} ans</span>
                </div>
              </div>
            </div>

            <!-- Interview Section -->
            <div class="detail-section">
              <div class="detail-section-title">
                <i class="fas fa-user-tie"></i>
                <span>Entretien</span>
              </div>
              <div class="detail-items">
                <div class="detail-item full-width">
                  <span class="detail-label">Statut</span>
                  <span class="detail-value">
                    <span class="interview-badge" 
                          [class.interview-scheduled]="app.interviewStatus !== 'NON_PLANIFIE'"
                          [class.interview-not-scheduled]="app.interviewStatus === 'NON_PLANIFIE'">
                      <i class="fas" [ngClass]="app.interviewStatus !== 'NON_PLANIFIE' ? 'fa-calendar-check' : 'fa-calendar-times'"></i>
                      {{ app.interviewStatus }}
                    </span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Comment Section -->
            <div class="detail-section full-width-section" *ngIf="app.commentaire">
              <div class="detail-section-title">
                <i class="fas fa-comment-alt"></i>
                <span>Commentaire</span>
              </div>
              <div class="comment-box">
                {{ app.commentaire }}
              </div>
            </div>

            <!-- Documents Section -->
            <div class="detail-section full-width-section">
              <div class="detail-section-title">
                <i class="fas fa-paperclip"></i>
                <span>Documents & Médias</span>
              </div>
              <div class="documents-grid">
                <div class="document-item" *ngIf="app.cvPath">
                  <div class="doc-icon">
                    <i class="fas fa-file-pdf"></i>
                  </div>
                  <div class="doc-info">
                    <span class="doc-name">Curriculum Vitae</span>
                    <span class="doc-type">PDF</span>
                  </div>
                  <a [href]="'http://localhost:8086/files/cv/' + app.cvPath" 
                     target="_blank" 
                     class="btn-doc-action">
                    <i class="fas fa-eye"></i>
                    Voir
                  </a>
                </div>

                <div class="document-item" *ngIf="app.videoPath">
                  <div class="doc-icon video-icon">
                    <i class="fas fa-video"></i>
                  </div>
                  <div class="doc-info">
                    <span class="doc-name">Vidéo de Présentation</span>
                    <span class="doc-type">MP4</span>
                  </div>
                  <button class="btn-doc-action" (click)="toggleVideo(app)">
                    <i class="fas" [ngClass]="app.showVideo ? 'fa-eye-slash' : 'fa-play'"></i>
                    {{ app.showVideo ? 'Masquer' : 'Lire' }}
                  </button>
                </div>

                <div class="document-item no-document" *ngIf="!app.cvPath && !app.videoPath">
                  <div class="doc-icon no-doc-icon">
                    <i class="fas fa-inbox"></i>
                  </div>
                  <div class="doc-info">
                    <span class="doc-name">Aucun document disponible</span>
                  </div>
                </div>
              </div>

              <!-- Video Player -->
              <div *ngIf="app.showVideo && app.videoPath" class="video-player-container">
                <video controls class="video-player">
                  <source [src]="'http://localhost:8086/video/' + app.videoPath" type="video/mp4">
                  Votre navigateur ne supporte pas la lecture de vidéos.
                </video>
              </div>
            </div>

          </div>
        </div>

      </div>

      <div *ngIf="!(selectedHistory.applications && selectedHistory.applications.length > 0)" class="no-applications-detail">
        <i class="fas fa-inbox"></i>
        <p>Aucune candidature trouvée pour ce candidat</p>
      </div>
    </div>

  </div>

</main>