name: Pipeline Backend

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: self-hosted
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'


      - name: Verify Maven
        run: C:\maven\apache-maven\bin\mvn.cmd --version
        shell: cmd

      - name: Build JAR with Maven
        run: C:\maven\apache-maven\bin\mvn.cmd clean package -DskipTests
        shell: cmd

      # Étapes critiques pour Docker sur Windows self-hosted
      - name: Verify Docker is running
        run: docker version || exit 1
        shell: cmd

      - name: Free disk space (optional but recommended on Windows runners)
        if: runner.os == 'Windows'
        run: |
          docker system prune -af --volumes
        shell: cmd

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        shell: cmd
        run: |
          echo "Current directory:"
          dir
          echo "Building image with tag: ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }}"
          
          docker build ^
            --pull ^
            --no-cache ^
            -t ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }} ^
            -t ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:latest .
          
          if %ERRORLEVEL% NEQ 0 (
            echo "Docker build failed"
            exit 1
          )
          
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:latest
        timeout-minutes: 121


      # Mise à jour du manifest k8s
      - name: Checkout k8s-manifests repo
        uses: actions/checkout@v4
        with:
          repository: firas100/k8s-manifests
          token: ${{ secrets.GH_PAT }}
          path: k8s-manifests

      - name: Update Kubernetes deployment image
        shell: pwsh
        run: |
          $manifestPath = "k8s-manifests/backend/deployment.yaml"
          if (Test-Path $manifestPath) {
            (Get-Content $manifestPath) -replace 'image: .*', "image: ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }}" | Set-Content $manifestPath
            cd k8s-manifests
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .
            if (git status --porcelain | Where-Object { $_ -match '^ M ' }) {
              git commit -m "Deploy backend ${{ github.sha }}"
              git push
              Write-Host "Manifest updated and pushed"
            } else {
              Write-Host "No changes in deployment.yaml"
            }
          } else {
            Write-Host "deployment.yaml not found at $manifestPath"
            exit 1
          }