name: Pipeline Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  security-events: write
  actions: read

jobs:
  build-deploy:
    runs-on: self-hosted
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Verify Maven Installation
        shell: powershell
        run: |
          & C:\maven\apache-maven\bin\mvn.cmd --version

      - name: Build with Maven
        shell: powershell
        run: |
          & C:\maven\apache-maven\bin\mvn.cmd clean package -DskipTests
        timeout-minutes: 15

      - name: Run Unit Tests
        shell: powershell
        run: |
          & C:\maven\apache-maven\bin\mvn.cmd test
        timeout-minutes: 10
        continue-on-error: true

      - name: Run Qodana Code Analysis
        shell: powershell
        run: |
          qodana scan --save-report --results-dir=qodana-results
        timeout-minutes: 15
        continue-on-error: true
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}

      - name: Upload Qodana Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('qodana-results/qodana.sarif.json') != ''
        with:
          sarif_file: qodana-results/qodana.sarif.json
        continue-on-error: true

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker Image
        shell: powershell
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }} -t ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:latest .
        timeout-minutes: 20

      - name: Push Docker Image to Registry
        shell: powershell
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:latest
          Write-Host "Image pushed successfully"
        timeout-minutes: 40

      - name: Checkout k8s-manifests Repository
        uses: actions/checkout@v4
        with:
          repository: firas100/k8s-manifests
          path: k8s-manifests
          token: ${{ secrets.GH_PAT }}

      - name: Update Kubernetes Deployment Manifest
        shell: powershell
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Updating Kubernetes Deployment Manifest" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          $manifestPath = "k8s-manifests/backend/deployment.yaml"
          
          if (Test-Path $manifestPath) {
              Write-Host "OK - Manifest file found: $manifestPath" -ForegroundColor Green
          
              $content = Get-Content $manifestPath -Raw
              $newImage = "image: ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }}"
              Write-Host "INFO - New image: $newImage" -ForegroundColor Cyan
          
              $newContent = $content -replace 'image:.*projetpfe-backend.*', $newImage
              Set-Content $manifestPath -Value $newContent
              Write-Host "OK - Manifest file updated" -ForegroundColor Green
          
              cd k8s-manifests
              git config user.name "firas100"
              git config user.email "firas100@users.noreply.github.com"
              git add backend/deployment.yaml
          
              $changes = git status --porcelain
              if ($changes) {
                  Write-Host "INFO - Changes detected, committing..." -ForegroundColor Yellow
                  git commit -m "chore: update backend image to ${{ github.sha }}"
          
                  Write-Host "INFO - Pushing to GitHub..." -ForegroundColor Yellow
                  git push
          
                  if ($LASTEXITCODE -eq 0) {
                      Write-Host "SUCCESS - Manifest pushed successfully" -ForegroundColor Green
                  } else {
                      Write-Host "ERROR - Failed to push manifest" -ForegroundColor Red
                      exit 1
                  }
              } else {
                  Write-Host "INFO - No changes detected in manifest" -ForegroundColor Yellow
              }
          } else {
              Write-Host "ERROR - Manifest file not found at: $manifestPath" -ForegroundColor Red
              exit 1
          }
          
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Deployment Update Complete" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan

      - name: Deployment Summary
        if: success()
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "     DEPLOYMENT SUCCESSFUL" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Image Details:" -ForegroundColor Cyan
          Write-Host "  Repository: ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend" -ForegroundColor White
          Write-Host "  Tag SHA: ${{ github.sha }}" -ForegroundColor White
          Write-Host "  Tag Latest: latest" -ForegroundColor White
          Write-Host ""
          Write-Host "Resources:" -ForegroundColor Cyan
          Write-Host "  Docker Hub: https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend" -ForegroundColor White
          Write-Host "  K8s Manifests: https://github.com/firas100/k8s-manifests" -ForegroundColor White
          Write-Host "  Qodana Report: https://qodana.cloud" -ForegroundColor White
          Write-Host ""