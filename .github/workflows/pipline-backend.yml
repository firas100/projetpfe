name: Pipeline Backend

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  security-events: write
  actions: read

jobs:
  build-deploy:
    runs-on: self-hosted
    timeout-minutes: 60

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 1. CHECKOUT & SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 2. BUILD & TEST
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Verify Maven Installation
        run: C:\maven\apache-maven\bin\mvn.cmd --version
        shell: cmd

      - name: Build with Maven
        run: C:\maven\apache-maven\bin\mvn.cmd clean package -DskipTests
        shell: cmd
        timeout-minutes: 15

      - name: Run Unit Tests
        run: C:\maven\apache-maven\bin\mvn.cmd test
        shell: cmd
        timeout-minutes: 10
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 3. CODE QUALITY ANALYSIS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Run Qodana Code Analysis
        run: qodana scan --save-report --results-dir=qodana-results
        shell: cmd
        timeout-minutes: 15
        continue-on-error: true
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}

      - name: Upload Qodana Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: qodana-results/qodana.sarif.json
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 4. DOCKER BUILD & PUSH
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }} -t ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:latest .
        shell: cmd
        timeout-minutes: 20

      - name: Push Docker Image to Registry
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:latest
          echo Image pushed successfully: ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }}
        shell: cmd
        timeout-minutes: 40

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 5. UPDATE KUBERNETES MANIFESTS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Checkout k8s-manifests Repository
        uses: actions/checkout@v4
        with:
          repository: firas100/k8s-manifests
          path: k8s-manifests
          token: ${{ secrets.GH_PAT }}

      - name: Update Kubernetes Deployment Manifest
        shell: powershell
        run: |
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "  Updating Kubernetes Deployment Manifest" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan
          
          $manifestPath = "k8s-manifests/backend/deployment.yaml"
          
          if (Test-Path $manifestPath) {
              Write-Host "[OK] Manifest file found: $manifestPath" -ForegroundColor Green
          
              # Read current content
              $content = Get-Content $manifestPath -Raw
          
              # Prepare new image tag
              $newImage = "image: ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend:${{ github.sha }}"
              Write-Host "[INFO] New image: $newImage" -ForegroundColor Cyan
          
              # Replace image line
              $newContent = $content -replace 'image:.*projetpfe-backend.*', $newImage
          
              # Write updated content
              Set-Content $manifestPath -Value $newContent
              Write-Host "[OK] Manifest file updated" -ForegroundColor Green
          
              # Navigate to manifests repo
              cd k8s-manifests
          
              # Configure Git
              git config user.name "firas100"
              git config user.email "firas100@users.noreply.github.com"
          
              # Add changes
              git add backend/deployment.yaml
          
              # Check for changes
              $changes = git status --porcelain
              if ($changes) {
                  Write-Host "[INFO] Changes detected, committing..." -ForegroundColor Yellow
          
                  # Commit
                  git commit -m "chore: update backend image to ${{ github.sha }}"
          
                  # Push
                  Write-Host "[INFO] Pushing to GitHub..." -ForegroundColor Yellow
                  git push
          
                  if ($LASTEXITCODE -eq 0) {
                      Write-Host "[SUCCESS] Manifest pushed successfully!" -ForegroundColor Green
                  } else {
                      Write-Host "[ERROR] Failed to push manifest (exit code: $LASTEXITCODE)" -ForegroundColor Red
                      exit 1
                  }
              } else {
                  Write-Host "[INFO] No changes detected in manifest" -ForegroundColor Yellow
              }
          } else {
              Write-Host "[ERROR] Manifest file not found at: $manifestPath" -ForegroundColor Red
              Write-Host "[INFO] Directory contents:" -ForegroundColor Yellow
              Get-ChildItem k8s-manifests -Recurse | Select-Object FullName
              exit 1
          }
          
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "  Deployment Update Complete" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Cyan

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 6. DEPLOYMENT SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Deployment Summary
        if: success()
        shell: powershell
        run: |
       
          Write-Host "ğŸ“¦ Image Details:" -ForegroundColor Cyan
          Write-Host "   Repository: ${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend" -ForegroundColor White
          Write-Host "   Tag (SHA):  ${{ github.sha }}" -ForegroundColor White
          Write-Host "   Tag (Latest): latest" -ForegroundColor White
          Write-Host ""
          Write-Host "ğŸ”— Resources:" -ForegroundColor Cyan
          Write-Host "   Docker Hub: https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/projetpfe-backend" -ForegroundColor White
          Write-Host "   K8s Manifests: https://github.com/firas100/k8s-manifests" -ForegroundColor White
          Write-Host "   Qodana Report: https://qodana.cloud" -ForegroundColor White
          Write-Host ""